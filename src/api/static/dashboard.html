<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>EatWise // Dashboard</title>
    <link rel="stylesheet" href="/static/css/gemini.css">
    <script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        /* Specific Fixes for Scroll */
        body,
        html {
            height: 100%;
            margin: 0;
            overflow: hidden;
        }

        .container {
            height: 100vh;
            padding: 20px;
            gap: 20px;
            display: grid;
            grid-template-columns: 260px 1fr;
            /* Fixed sidebar, flexible chat */
            box-sizing: border-box;
        }

        .chat-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            min-height: 0;
            /* Important for scroll */
        }

        .msg-area {
            flex: 1;
            overflow-y: auto;
            /* Scroll inside chat only */
            padding: 24px;
            scroll-behavior: smooth;
        }

        .input-bar {
            flex-shrink: 0;
        }

        /* Node Editor Modal */
        #edit-node-modal {
            z-index: 2000;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar-nav card" style="height: 100%; display: flex; flex-direction: column;">
            <h2 style="padding: 0 8px; color: var(--primary-color);">EatWise ðŸŒ¿</h2>
            <button class="btn" onclick="newSession()" style="width:100%; margin: 10px 0;">+ New Session</button>

            <h4 style="margin: 10px 0 5px 8px; color: #94a3b8; font-size: 0.8rem;">HISTORY</h4>
            <div id="session-list" style="flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:4px;"></div>

            <div style="margin-top:auto; border-top: 1px solid #e2e8f0; padding-top: 10px;">
                <div class="nav-item" onclick="toggleGraph()">
                    <span class="material-icons-round">hub</span> Manage Memory
                </div>
                <div class="nav-item" onclick="logout()">
                    <span class="material-icons-round">logout</span> Log Out
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-container">
            <div id="msg-area" class="msg-area">
                <div class="msg bot">Hello! I'm your EatWise assistant. How can I help you eat healthier today?</div>
            </div>

            <div class="input-bar">
                <button id="btn-mic" class="btn btn-secondary" style="padding: 12px; border-radius: 50%;"
                    onclick="toggleVoice()">
                    <span class="material-icons-round" id="icon-mic">mic</span>
                </button>
                <input type="text" id="user-input" class="input-field" placeholder="Ask about nutrition..."
                    onkeydown="handleEnter(event)">
                <button class="btn" onclick="sendMsg()" style="border-radius: 50%; padding: 12px;">
                    <span class="material-icons-round">send</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden Audio -->
    <audio id="audio-out"></audio>

    <!-- Graph Modal -->
    <div id="graph-modal" class="modal">
        <div class="modal-content">
            <div
                style="padding: 20px; border-bottom: 1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                <h3>Your Nutrition Knowledge Graph</h3>
                <p style="font-size:0.8rem; color:#64748b;">Click a node to Edit/Delete</p>
                <button class="btn btn-secondary" onclick="toggleGraph()">Close</button>
            </div>
            <div id="network" style="width:100%; height: calc(100% - 70px);"></div>
        </div>
    </div>

    <!-- Edit Node Modal -->
    <div id="edit-node-modal" class="modal">
        <div class="card" style="width: 400px; padding: 20px;">
            <h3>Edit Fact</h3>
            <input type="text" id="edit-node-label" class="input-field" style="margin-bottom: 20px;">
            <div style="display:flex; justify-content: space-between;">
                <button class="btn" style="background: #ef4444;" onclick="deleteNode()">Delete</button>
                <div>
                    <button class="btn btn-secondary" onclick="closeEdit()">Cancel</button>
                    <button class="btn" onclick="saveNode()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/';

        let currentSession = null;
        let voiceActive = false;
        let selectedNodeId = null;

        // --- Init Graph ---
        const container = document.getElementById('network');
        const nodes = new vis.DataSet([]);
        const edges = new vis.DataSet([]);
        const network = new vis.Network(container, { nodes, edges }, {
            nodes: {
                shape: 'dot',
                size: 20,
                font: { face: 'Inter', size: 14, color: '#333' },
                borderWidth: 2,
                color: { background: '#ccfbf1', border: '#0d9488' }
            },
            edges: { color: '#cbd5e1', width: 1.5 },
            interaction: { hover: true, tooltipDelay: 200 }
        });

        network.on("click", function (params) {
            if (params.nodes.length > 0) {
                const nodeId = params.nodes[0];
                const node = nodes.get(nodeId);
                openEdit(nodeId, node.label);
            }
        });

        // --- Logic ---
        function handleEnter(e) { if (e.key === 'Enter') sendMsg(); }

        function toggleGraph() {
            const m = document.getElementById('graph-modal');
            m.classList.toggle('visible');
            if (m.classList.contains('visible')) refreshGraph();
        }

        // Edit Modal
        function openEdit(id, label) {
            selectedNodeId = id;
            document.getElementById('edit-node-label').value = label;
            document.getElementById('edit-node-modal').classList.add('visible');
        }
        function closeEdit() { document.getElementById('edit-node-modal').classList.remove('visible'); }

        async function saveNode() {
            const label = document.getElementById('edit-node-label').value;
            try {
                const res = await fetch(`/graph/node/${selectedNodeId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ label })
                });
                if (res.ok) {
                    refreshGraph();
                    closeEdit();
                }
            } catch (e) { alert("Error saving"); }
        }

        async function deleteNode() {
            if (!confirm("Are you sure you want to delete this fact?")) return;
            try {
                const res = await fetch(`/graph/node/${selectedNodeId}`, { method: 'DELETE' });
                if (res.ok) {
                    refreshGraph();
                    closeEdit();
                }
            } catch (e) { alert("Error deleting"); }
        }

        function logout() { localStorage.removeItem('token'); window.location.href = '/'; }

        async function sendMsg() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if (!text) return;

            addBubble(text, 'user');
            input.value = '';

            try {
                const res = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: text,
                        voice_enabled: true,
                        session_id: currentSession
                    })
                });
                const data = await res.json();
                currentSession = data.session_id;

                addBubble(data.response_text, 'bot');

                if (data.audio_path) {
                    const audio = document.getElementById('audio-out');
                    audio.src = data.audio_path;
                    audio.play().catch(e => console.log("Audio info: " + e));
                }

                refreshSessions();
            } catch (e) { addBubble("Connection error.", 'bot'); }
        }

        function addBubble(text, role) {
            const area = document.getElementById('msg-area');
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            div.innerHTML = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
            area.appendChild(div);
            // SCROLL TO BOTTOM
            setTimeout(() => { area.scrollTop = area.scrollHeight; }, 50);
        }

        async function refreshGraph() {
            try {
                const res = await fetch('/graph/');
                const data = await res.json();
                nodes.clear();
                edges.clear();
                data.nodes.forEach(n => {
                    if (n.label === 'User') { n.color = { background: '#1e293b', border: '#000' }; n.font = { color: 'white' }; n.size = 30; }
                    else { n.color = { background: '#ccfbf1', border: '#0d9488' }; }
                    nodes.add(n);
                });
                edges.add(data.edges);
            } catch (e) { }
        }

        async function refreshSessions() {
            const res = await fetch('/sessions');
            const list = await res.json();
            const container = document.getElementById('session-list');
            container.innerHTML = '';
            list.forEach(s => {
                const div = document.createElement('div');
                div.className = 'nav-item';
                div.innerHTML = `<span class="material-icons-round" style="font-size:16px;">chat_bubble_outline</span> ${s.title || 'Chat'}`;
                if (s.id === currentSession) div.classList.add('active');
                div.onclick = () => loadSession(s.id);
                container.appendChild(div);
            });
        }

        async function loadSession(id) {
            currentSession = id;
            document.getElementById('msg-area').innerHTML = '';
            const res = await fetch(`/sessions/${id}`);
            const msgs = await res.json();
            msgs.forEach(m => addBubble(m.content, m.role === 'user' ? 'user' : 'bot'));
            refreshSessions();
        }

        function newSession() {
            currentSession = null;
            document.getElementById('msg-area').innerHTML = '<div class="msg bot">Hello! I\'m your EatWise assistant. How can I help you?</div>';
            refreshSessions();
        }

        // Voice
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.onresult = (e) => {
                document.getElementById('user-input').value = e.results[0][0].transcript;
                sendMsg();
            };
            recognition.onend = () => {
                document.getElementById('icon-mic').style.color = 'inherit';
                voiceActive = false;
            };
        }

        function toggleVoice() {
            if (!recognition) return;
            if (voiceActive) recognition.stop();
            else {
                voiceActive = true;
                document.getElementById('icon-mic').style.color = 'red';
                recognition.start();
            }
        }

        refreshSessions();
    </script>
</body>

</html>